<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Medical Note & ICD Codes</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .icd-container { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
    .result-item { margin: 5px 0; display: flex; align-items: center; padding: 5px; border-bottom: 1px solid #eee; }

    .category-boxes { display: flex; overflow-x: auto; white-space: nowrap; gap: 8px; margin-bottom: 10px; padding-bottom: 5px; }
    .category-box { padding: 5px 10px; border: 1px solid #007BFF; border-radius: 5px; background-color: #f0f8ff; cursor: pointer; transition: all 0.2s; flex: 0 0 auto; font-size: 0.9rem; }
    .category-box:hover, .category-box.active { background-color: #007BFF; color: white; font-weight: bold; }

    #selectedCodesContainer { display: flex; overflow-x: auto; white-space: nowrap; gap: 5px; margin-bottom: 10px; padding-bottom: 5px; }
    .selected-code { background-color: #007BFF; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; flex: 0 0 auto; }
    .selected-code span { cursor: pointer; font-weight: bold; }

    .category-boxes, #selectedCodesContainer { -ms-overflow-style: none; scrollbar-width: none; }
    .category-boxes::-webkit-scrollbar, #selectedCodesContainer::-webkit-scrollbar { display: none; }

    .row { margin-bottom: 15px; }
    .row label { display: block; margin-bottom: 5px; font-weight: bold; }
    input[type=text], textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 15px 12px; border: none; background-color: #007BFF; color: white; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    .banner {
    display: none;
    padding: 12px 16px;
    border-radius: 10px;
    margin: 12px auto 0;
    max-width: 540px;
    text-align: center;
    font-weight: 600;
    transition: all 0.3s;
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }
  .banner.show { display: block; }
  .banner.success { background: #2e7d32; color: white; }
  .banner.error { background: #f44336; color: white; }
  .row.actions {
  text-align: center;
  margin-top: 20px;
}
/* ---------------- Search Bar Design ---------------- */
.search-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 15px;
  margin-bottom: 10px;
}

.search-bar {
  width: 100%;
  max-width: 450px;
}

#searchBox {
  width: 100%;
  padding: 12px 14px;
  border: 2px solid #007BFF;
  border-radius: 8px;
  font-size: 1rem;
  outline: none;
  transition: all 0.3s;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

#searchBox:focus {
  border-color: #0056b3;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

/* Move button slightly down */
.search-btn-wrapper {
  margin-top: 10px;
}

.search-btn {
  background-color: #007BFF;
  color: white;
  border: none;
  padding: 10px 22px;
  font-size: 1rem;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.search-btn:hover {
  background-color: #0056b3;
}

  </style>
</head>
<body class="form-page medical-note">

{% include "header.html" %}

<nav class="ouwn-breadcrumb-bar" role="navigation" aria-label="Breadcrumb">
    <div class="ouwn-crumbs">
        <a class="crumb" href="{{ url_for('dashboard') }}">
            <i class="fa-solid fa-house"></i>
            <span>Dashboard</span>
        </a>
        <span class="sep" aria-hidden="true">/</span>
        <span class="crumb current" aria-current="page">
        <i class="fa-solid fa-file-medical"></i>
        <span>Add Medical Notes</span>
        </span>
    </div>
</nav>
<div id="saveMessage" class="banner"></div>
<main class="container">
    <h1>Add Medical Note</h1>
    <form id="noteForm" class="card">
        <div class="row">
            <label for="pid">National ID / Iqama <span class="required">*</span></label>
            <input name="pid" id="pid" type="text" style="background-color: lightgray;" value="{{ prefilled_pid }}" readonly required />
        </div>
        <div class="row">
            <label for="note_text">Note <span class="required">*</span></label>
            <textarea name="note_text" id="note_text" rows="6" required>{{ note_text }}</textarea>
        </div>
    </form>

    <div class="icd-container">
        <h2>ICD Code Browser</h2>
        <div id="categoryBoxes" class="category-boxes"></div>
        <div id="selectedCodesContainer"></div>
        <div class="search-section">
    <div class="search-bar">
        <input type="text" id="searchBox" placeholder="üîç Search ICD code or keyword...">
    </div>
    <div class="search-btn-wrapper">
        <button type="button" class="search-btn" onclick="searchICD()">Search</button>
    </div>
</div>

        <div id="results" style="margin-top: 10px;"></div>
         <div class="row actions" style="margin-top: 20px; text-align: center;">
      <button type="button" id="saveBothBtn">Save Note & ICD Codes</button>
  </div>
    </div>
</main>

<footer>
    <p>&copy; 2025 OuwN. All Rights Reserved.</p>
</footer>

<script>
let selectedCodes = {{ selected_icd_codes | default([]) | tojson | safe }};
let currentCategory = "";

// -----------------------------
// Show floating banner message
// -----------------------------
function showMessage(msg, type = "success", duration = 3000) {
    const banner = document.getElementById("saveMessage");
    banner.textContent = msg;
    banner.className = `banner show ${type}`;
    setTimeout(() => banner.className = "banner", duration);
}

// -----------------------------
// Update selected codes UI
// -----------------------------
function updateSelectedCodesUI() {
    const container = document.getElementById("selectedCodesContainer");
    container.innerHTML = "";
    selectedCodes.forEach(c => {
        const div = document.createElement("div");
        div.className = "selected-code";
        div.innerHTML = `${c.Code} <span onclick="removeCode('${c.Code}')">x</span>`;
        container.appendChild(div);
    });
}

// -----------------------------
// Remove code
// -----------------------------
function removeCode(code) {
    selectedCodes = selectedCodes.filter(c => c.Code !== code);
    const cb = document.querySelector(`#results input[data-code='${code}']`);
    if (cb) cb.checked = false;
    updateSelectedCodesUI();
}

// -----------------------------
// Load ICD categories
// -----------------------------
window.onload = function() {
    updateSelectedCodesUI();

    fetch("/icd_categories")
    .then(res => res.json())
    .then(categories => {
        const container = document.getElementById("categoryBoxes");
        categories.forEach(cat => {
            const box = document.createElement("div");
            box.className = "category-box";
            box.textContent = cat;
            box.addEventListener("click", () => {
                document.querySelectorAll(".category-box").forEach(b => b.classList.remove("active"));
                box.classList.add("active");
                currentCategory = cat;
                loadByCategory(cat);
            });
            container.appendChild(box);
        });
    });
};

// -----------------------------
// Load ICD codes by category
// -----------------------------
function loadByCategory(category) {
    if (!category) return;
    fetch(`/icd_by_category/${encodeURIComponent(category)}`)
    .then(res => res.json())
    .then(data => displayICDResults(data));
}

// -----------------------------
// Search ICD codes
// -----------------------------
function searchICD() {
    const term = document.getElementById("searchBox").value.trim();
    if (!term) return;
    fetch(`/search_icd?term=${encodeURIComponent(term)}&category=${encodeURIComponent(currentCategory)}`)
    .then(res => res.json())
    .then(data => displayICDResults(data));
}

// -----------------------------
// Display ICD results
// -----------------------------
function displayICDResults(data) {
    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "";

    if (data.length === 0) { 
        resultsDiv.innerHTML = "<p>No results found.</p>"; 
        return; 
    }

    data.forEach(item => {
        const div = document.createElement("div");
        div.className = "result-item";

        const checked = selectedCodes.some(c => c.Code === item.Code) ? "checked" : "";

        div.innerHTML = `
            <input type="checkbox" data-code="${item.Code}" data-desc="${item.Description}" ${checked}>
            <strong style="margin-left:5px;">${item.Code}</strong> - ${item.Description}
        `;
        resultsDiv.appendChild(div);
    });
}

// -----------------------------
// Handle checkbox selection
// -----------------------------
document.getElementById("results").addEventListener("change", function(e) {
    if (e.target && e.target.matches("input[type='checkbox']")) {
        const code = e.target.dataset.code;
        const desc = e.target.dataset.desc;

        if (e.target.checked) {
            if (!selectedCodes.find(c => c.Code === code)) selectedCodes.push({ Code: code, Description: desc });
        } else {
            selectedCodes = selectedCodes.filter(c => c.Code !== code);
        }
        updateSelectedCodesUI();
    }
});

// -----------------------------
// Save note and ICD codes
// -----------------------------
document.getElementById("saveBothBtn").addEventListener("click", async () => {
    const pid = document.getElementById("pid").value.trim();
    const note = document.getElementById("note_text").value.trim();

    if (!pid) { showMessage("Patient ID is missing!", "error"); return; }
    if (!note) { showMessage("Please enter a medical note!", "error"); return; }
    if (selectedCodes.length === 0) { showMessage("Please select at least one ICD code!", "error"); return; }

    try {
        const response = await fetch("/MedicalNotes", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pid, note_text: note, icd_codes: selectedCodes })
        });

        const result = await response.json();
        if (result.status === "success" && result.redirect) {
            showMessage("‚úÖ Medical note and ICD codes saved successfully!", "success");
            setTimeout(() => window.location.href = result.redirect, 1500);
        } else {
            showMessage("‚ùå Error: " + result.message, "error");
        }
    } catch (err) {
        console.error("Error:", err);
        showMessage("An error occurred while saving note and codes.", "error");
    }
});
</script>
</body>
</html>
