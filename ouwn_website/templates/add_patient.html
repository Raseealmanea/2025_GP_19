<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Add Patient</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="form-page medical-note">

{% include "header.html" %}
<nav class="ouwn-breadcrumb-bar" role="navigation" aria-label="Breadcrumb">
  <div class="ouwn-crumbs">
    <a class="crumb" href="{{ url_for('dashboard') }}">
      <i class="fa-solid fa-house"></i>
      <span>Dashboard</span>
    </a>
    <span class="sep" aria-hidden="true">/</span>
    <span class="crumb current" aria-current="page">
      <i class="fa-solid fa-user"></i>
      <span>add patient</span>
    </span>
  </div>
</nav>

<main class="container card" style="padding:24px 24px 16px;">
  <h1 style="margin-top:0">Add Patient</h1>

  {% if errors %}
  <div class="alert error" style="margin-bottom:16px">
    <ul>{% for e in errors %}<li>{{ e }}</li>{% endfor %}</ul>
  </div>
  {% endif %}

  <form id="patientForm" method="POST" novalidate>
    
    <!-- Full Name -->
    <div class='row'>
      <label for='full_name'>Full Name<span class='required'>*</span></label>
      <div class='control'>
        <input id='full_name' name='full_name' type='text' required value="{{ request.form.get('full_name', '') }}">
        <div class='feedback'></div>
      </div>
    </div>

    <!-- Date of Birth -->
    <div class='row'>
      <label for='dob'>Date of Birth<span class='required'>*</span></label>
      <div class='control'>
        <input id='dob' name='dob' type='date' required value="{{ request.form.get('dob', '') }}">
        <div class='feedback'></div>
      </div>
    </div>

    <!-- Gender -->
    <div class="row">
      <label for="gender">Gender<span class="required">*</span></label>
      <div class="control">
        <select id="gender" name="gender" required>
          <option value="">Choose</option>
          <option value="M" {% if request.form.get('gender') == 'M' %}selected{% endif %}>Male</option>
          <option value="F" {% if request.form.get('gender') == 'F' %}selected{% endif %}>Female</option>
        </select>
        <div class="feedback"></div>
      </div>
    </div>

    <!-- National ID -->
    <div class='row'>
      <label for='ID'>National ID / Iqama<span class='required'>*</span></label>
      <div class='control'>
        <input id='ID' name='ID' type='text' maxlength='10' minlength='10' required
          oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10);"
          value="{{ request.form.get('ID', '') }}">
        <div class='feedback'></div>
      </div>
    </div>

    <!-- Phone -->
    <div class='row'>
      <label for='phone'>Phone<span class='required'>*</span></label>
      <div class='control'>
        <input id='phone' name='phone' type='tel' maxlength='10' minlength='10' required
          oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10);"
          value="{{ request.form.get('phone', '') }}">
        <div class='feedback'></div>
      </div>
    </div>

    <!-- Email -->
    <div class='row'>
      <label for='email'>Email<span class='required'>*</span></label>
      <div class='control'>
        <input id='email' name='email' type='email' required value="{{ request.form.get('email', '') }}">
        <div class='feedback'></div>
      </div>
    </div>

    <!-- Address -->
    <div class='row'>
      <label for='address'>Address<span class='required'>*</span></label>
      <div class='control'>
        <input id='address' name='address' type='text' required value="{{ request.form.get('address', '') }}">
        <div class='feedback'></div>
      </div>
    </div>

    <!-- Blood Type -->
    <div class="row">
      <label for="blood_type">Blood Type<span class="required">*</span></label>
      <div class="control">
        <select id="blood_type" name="blood_type" required>
          <option value="">Select</option>
          {% for b in ['A+','A-','B+','B-','AB+','AB-','O+','O-'] %}
            <option value="{{ b }}" {% if request.form.get('blood_type') == b %}selected{% endif %}>{{ b }}</option>
          {% endfor %}
        </select>
        <div class="feedback"></div>
      </div>
    </div>

    <div class="row actions">
      <button type='submit'>Add Patient</button>
    </div>
  </form>
</main>

<script>
// Helper to set UI
function setValidity(input, ok, msg){
  const fb = input.closest('.control').querySelector('.feedback');
  input.classList.toggle('is-valid', ok);
  input.classList.toggle('is-invalid', !ok);
  fb.textContent = ok ? "" : msg || "";
  fb.classList.toggle('valid', ok);
}

/* LIVE VALIDATION ONLY FOR: DOB, ID, PHONE, EMAIL */

// DOB
const dob = document.getElementById('dob');
function checkDob() {
  const v = dob.value;
  if (!v) { setValidity(dob, false, "Date of Birth is required."); return; }
  const d = new Date(v + "T00:00:00");
  if (isNaN(d.getTime())) { setValidity(dob, false, "Invalid date."); return; }
  const now = new Date();
  if (d > now) { setValidity(dob, false, "Date of Birth cannot be in the future."); return; }
  let age = now.getFullYear() - d.getFullYear();
  const mdNow = (now.getMonth()+1)*100 + now.getDate();
  const mdDob = (d.getMonth()+1)*100 + d.getDate();
  if (mdDob > mdNow) age--;
  if (age > 130) { setValidity(dob, false, "Age cannot exceed 130 years."); return; }
  setValidity(dob, true);
}
dob.addEventListener('input', checkDob);
dob.addEventListener('change', checkDob);

// ID: 10 digits + duplicate check
let idTimer;
const idInput = document.getElementById('ID');
idInput.addEventListener('input', ()=>{
  const v = idInput.value.trim();
  if (!/^\d{10}$/.test(v)) { setValidity(idInput, false, "Must be exactly 10 digits."); return; }
  clearTimeout(idTimer);
  idTimer = setTimeout(()=>{
   fetch(`/check_id?v=${encodeURIComponent(v)}`)
      .then(r => r.json())
      .then(d => {
        if (d.exists) {
          setValidity(idInput, false, "This ID already exists.");
        } else {
          setValidity(idInput, true);
        }
      })
      .catch(() => setValidity(idInput, true)); // fallback
  }, 300);
});

// Phone
const phone = document.getElementById('phone');
phone.addEventListener('input', ()=>{
  const ok = /^05\d{8}$/.test(phone.value.trim());
  setValidity(phone, ok, "Must start with 05 and be 10 digits.");
});

// Email
const email = document.getElementById('email');
email.addEventListener('input', ()=>{
  const ok = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i.test(email.value.trim());
  setValidity(email, ok, "Invalid email format.");
});
</script>
</body>
</html>
