<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up • OuwN</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="auth-page-body">

<!-- Header -->
<header class="header">
    <div class="header-left">
        <img src="{{ url_for('static', filename='logo.svg') }}" alt="OuwN Logo" class="logo-img">
    </div>
    <div class="header-right">
        <nav class="header-nav">
             <a href="{{ url_for('home') }}#about">About</a>
        <a href="{{ url_for('home') }}#vision">Vision</a>
        </nav>
    </div>
</header>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
             <div class="banner {{ category }} show">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<main class="auth-container">
    <h2 class="auth-title">Create your account</h2>

    <!-- Signup form -->
    <form method="POST" action="{{ url_for('Authentication.signup') }}" class="auth-form">

        <label>First name</label>
        <input id="first_name" name="first_name" type="text"
               placeholder="e.g., Sara" required value="{{ entered.first_name }}">

        <label>Last name</label>
        <input id="last_name" name="last_name" type="text"
               placeholder="e.g., Al-Harbi" required value="{{ entered.last_name }}">

        <label>Username</label>
        <input id="username" name="username" type="text"
               placeholder="Choose a username" required value="{{ entered.username }}">
        <small id="username-msg" class="field-msg"></small>

        <label>Email</label>
        <input id="email" name="email" type="email"
               placeholder="you@example.com" required value="{{ entered.email }}">
        <small id="email-msg" class="field-msg"></small>

        <label>Password</label>
        <input id="password" name="password" type="password"
               placeholder="Create a password" required>

        <!-- Password live rules -->
        <ul class="pw-checklist" id="pwChecklistLive">
            <li data-k="len"><span class="pw-icon">❌</span> At least 8 characters</li>
            <li data-k="upper"><span class="pw-icon">❌</span> Uppercase letter</li>
            <li data-k="lower"><span class="pw-icon">❌</span> Lowercase letter</li>
            <li data-k="digit"><span class="pw-icon">❌</span> Number (0–9)</li>
            <li data-k="special"><span class="pw-icon">❌</span> Special character (!@#…)</li>
        </ul>

        <button type="submit" class="btn">Sign up</button>
    </form>

    <p class="auth-meta">
        Already have an account?
        <a href="{{ url_for('Authentication.login') }}">Log In</a>
    </p>
</main>

<footer>
    <p>&copy; 2025 OuwN. All Rights Reserved.</p>
</footer>

<script>
/*  prevent spam calls while typing */
function debounce(fn, wait) {
    let t;
    return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
    };
}

/* AJAX validation request */
async function checkField(field, value) {
    if (!value) return { ok:true, exists:false, valid:false, msg:"" };

    try {
        const res = await fetch(`/check?field=${field}&value=${value}`);
        const data = await res.json();
        let msg = "";

        if (!data.valid) {
            msg = (field === "username")
                ? "Username must start with a capital letter and be 3–32 chars."
                : "Please enter a valid email address.";
        }
        else if (data.exists) {
            msg = (field === "username")
                ? "Username already taken"
                : "Email already in use";
        }

        return { ...data, msg };
    }
    catch (e) {
        console.error(e);
        return { ok:false, valid:false, exists:false, msg:"Server error" };
    }
}

/* Update validation UI */
function updateField(input, msgEl, state) {
    const val = input.value.trim();

    // No text → clear validation
    if (!val) {
        input.classList.remove("is-valid", "is-invalid");
        msgEl.textContent = "";
        msgEl.classList.remove("err", "ok");
        return;
    }

    // Invalid or exists → show red
    if (!state.ok || !state.valid || state.exists) {
        input.classList.add("is-invalid");
        input.classList.remove("is-valid");
        msgEl.textContent = state.msg;
        msgEl.classList.add("err");
        msgEl.classList.remove("ok");
        // Valid → show green
    } else {
        input.classList.add("is-valid");
        input.classList.remove("is-invalid");
        msgEl.textContent = "";
        msgEl.classList.remove("err", "ok");
    }
}

/* Inputs */
const usernameEl = document.querySelector("#username");
const emailEl    = document.querySelector("#email");
const usernameMsg = document.querySelector("#username-msg");
const emailMsg    = document.querySelector("#email-msg");

/* Username live check */
usernameEl.addEventListener("input", debounce(async () => {
    const state = await checkField("username", usernameEl.value.trim());
    updateField(usernameEl, usernameMsg, state);
}, 300));

/* Email live check */
emailEl.addEventListener("input", debounce(async () => {
    const state = await checkField("email", emailEl.value.trim());
    updateField(emailEl, emailMsg, state);
}, 300));

/* Password strength checker */
(function () {
    const pw = document.getElementById("password");
    const list = document.getElementById("pwChecklistLive");

    function evalPw(v) {
        return {
            len: v.length >= 8,
            upper: /[A-Z]/.test(v),
            lower: /[a-z]/.test(v),
            digit: /\d/.test(v),
            special: /[^A-Za-z0-9]/.test(v)
        };
    }

    // Set the checklist row to ok/bad
    function setRow(k, ok) {
        const li = list.querySelector(`li[data-k="${k}"]`);
        li.classList.toggle("pw-ok", ok);
        li.classList.toggle("pw-bad", !ok);
        li.querySelector(".pw-icon").textContent = ok ? "✅" : "❌";
    }

     // Update as user types
    pw.addEventListener("input", () => {
        const c = evalPw(pw.value);
        ['len','upper','lower','digit','special'].forEach(k => setRow(k, c[k]));
        const allOk = Object.values(c).every(Boolean);

        pw.classList.toggle("is-invalid", !allOk && pw.value.length > 0);
        pw.classList.toggle("is-valid", allOk);
    });

    // Show checklist only when focused
    pw.addEventListener("focus", () => list.style.display = "block");
    pw.addEventListener("blur", () => {
        if (!pw.value.trim()) list.style.display = "none";
    });
})();
/* Auto-hide banners */
 setTimeout(() => {
    const banner = document.querySelector('.banner.show');
    if (banner) {
      banner.classList.remove('show');
    }
  }, 4000);
</script>

</body>
</html>
