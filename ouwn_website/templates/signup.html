<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sign Up • OuwN</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
  .banner { display:none; padding:12px 16px; border-radius:10px; margin:12px auto 0; max-width:540px; text-align:center; }
  .banner.show{ display:block; }
  .banner.err{ background:#f44336; color:#fff; }
  .banner.ok{  background:#2e7d32; color:#fff; }

  .auth-form { max-width:540px; margin:0 auto; }
  .auth-form label { display:block; font-weight:600; margin-top:12px; }
  .auth-form input { width:100%; padding:10px 12px; border:1px solid #ccc; border-radius:8px; margin-top:6px; }
  input.is-valid { border-color: #2e7d32; box-shadow: 0 0 0 3px rgba(46,125,50,.25); }
  input.is-invalid { border-color: #e53935; box-shadow: 0 0 0 3px rgba(229,57,53,.25); }

  .pw-checklist { list-style:none; padding-left:0; margin-top:8px; }
  .pw-checklist li { margin-bottom:6px; }
  .pw-ok .pw-icon { color: #2e7d32; }
  .pw-bad .pw-icon { color: #f44336; }
  .field-msg { font-size: 0.875rem; margin-top: 4px; display:block; }
.field-msg.ok { color: #2e7d32; }  /* green */
.field-msg.err { color: #e53935; } /* red */

</style>
</head>
<body class="auth-page-body">


<header class="header">
  <div class="header-left">
    <img src="{{ url_for('static', filename='logo.svg') }}" alt="OuwN Logo" class="logo-img">
  </div>
  <nav class="header-nav">
    <a href="{{ url_for('home') }}#about">About</a>
    <a href="{{ url_for('home') }}#vision">Vision</a>
  </nav>
</header>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="banner {{ 'ok' if category=='success' else 'err' }} show">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<main class="auth-container">
  <h2 class="auth-title">Create your account</h2>
  <form method="POST" action="{{ url_for('Authentication.signup') }}" class="auth-form">
    <label>First name</label>
    <input id="first_name" name="first_name" type="text" placeholder="e.g., Sara" required
           value="{{ entered.first_name }}">

    <label>Last name</label>
    <input id="last_name" name="last_name" type="text" placeholder="e.g., Al-Harbi" required
           value="{{ entered.last_name }}">

    <label>Username</label>
    <input id="username" name="username" type="text" placeholder="Choose a username" required
           value="{{ entered.username }}">
    <small id="username-msg" class="field-msg"></small>

    <label>Email</label>
    <input id="email" name="email" type="email" placeholder="you@example.com" required
           value="{{ entered.email }}">
    <small id="email-msg" class="field-msg"></small>

    <label>Password</label>
    <input id="password" name="password" type="password" placeholder="Create a password" required>

    <ul class="pw-checklist" id="pwChecklistLive">
      <li data-k="len"><span class="pw-icon">❌</span> At least 8 characters</li>
      <li data-k="upper"><span class="pw-icon">❌</span> Uppercase letter</li>
      <li data-k="lower"><span class="pw-icon">❌</span> Lowercase letter</li>
      <li data-k="digit"><span class="pw-icon">❌</span> Number (0–9)</li>
      <li data-k="special"><span class="pw-icon">❌</span> Special character (!@#…)</li>
    </ul>

    <button type="submit" class="btn">Sign up</button>
  </form>

  <p class="auth-meta">Already have an account? <a href="{{ url_for('Authentication.login') }}">Log In</a></p>
</main>

<footer>
  <p>&copy; 2025 OuwN. All Rights Reserved.</p>
</footer>

<script>
// debounce helper
// debounce helper
function debounce(fn, wait) {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
}

// AJAX check availability
async function checkField(field, value) {
    if (!value) return { ok: true, exists: false, valid: false, msg: "" };
    try {
        const res = await fetch(`/check?field=${encodeURIComponent(field)}&value=${encodeURIComponent(value)}`);
        const data = await res.json();
        let msg = "";
        if (!data.valid) msg = field === "username" ? "Invalid username (3–32 letters/numbers/_/-)" : "Invalid email format";
        else if (data.exists) msg = field === "username" ? "Username already taken" : "Email already in use";
        return { ...data, msg };
    } catch (e) {
        console.error("Check field error:", e);
        return { ok: false, exists: false, valid: false, msg: "Server error" };
    }
}

// update input styles & message
function updateField(input, msgEl, state) {
    if (!input.value.trim()) {
        input.classList.remove("is-valid", "is-invalid");
        msgEl.textContent = "";
        msgEl.classList.remove("ok", "err");
        return;
    }

    if (!state.ok || !state.valid || state.exists) {
        // Invalid state: show red border + message
        input.classList.add("is-invalid");
        input.classList.remove("is-valid");
        msgEl.textContent = state.msg;   // show error message
        msgEl.classList.add("err");
        msgEl.classList.remove("ok");
    } else {
        // Valid state: show green border, no message
        input.classList.add("is-valid");
        input.classList.remove("is-invalid");
        msgEl.textContent = "";           // remove message
        msgEl.classList.remove("err");
        msgEl.classList.remove("ok");
    }
}


// attach events
const usernameEl = document.querySelector("#username");
const emailEl = document.querySelector("#email");
const usernameMsg = document.querySelector("#username-msg");
const emailMsg = document.querySelector("#email-msg");

const runUserCheck = debounce(async () => {
    const state = await checkField("username", usernameEl.value.trim());
    updateField(usernameEl, usernameMsg, state);
}, 300);

const runEmailCheck = debounce(async () => {
    const state = await checkField("email", emailEl.value.trim());
    updateField(emailEl, emailMsg, state);
}, 300);

usernameEl.addEventListener("input", runUserCheck);
emailEl.addEventListener("input", runEmailCheck);

// live password checklist
(function(){
    const pw = document.getElementById('password');
    const list = document.getElementById('pwChecklistLive');
    function evalPw(v){return{
        len: v.length>=8,
        upper:/[A-Z]/.test(v),
        lower:/[a-z]/.test(v),
        digit:/\d/.test(v),
        special:/[^A-Za-z0-9]/.test(v)
    };}

    function setRow(k,ok){
        const li = list.querySelector('li[data-k="'+k+'"]');
        if(!li) return;
        li.classList.toggle('pw-ok',ok);
        li.classList.toggle('pw-bad',!ok);
        li.querySelector('.pw-icon').textContent = ok?'✅':'❌';
    }

    pw.addEventListener('input', ()=>{
        const c = evalPw(pw.value);
        ['len','upper','lower','digit','special'].forEach(k=>setRow(k,c[k]));
        pw.classList.toggle('is-invalid',!Object.values(c).every(Boolean)&&pw.value.length>0);
        pw.classList.toggle('is-valid',Object.values(c).every(Boolean));
    });
})();
// Show/hide password checklist on focus/blur
(function() {
  const pw = document.getElementById('password');
  const list = document.getElementById('pwChecklistLive');

  // Hide the checklist initially
  list.style.display = "none";

  // When user clicks (focus) on the password field
  pw.addEventListener('focus', () => {
    list.style.display = "block";
  });

  // When user clicks outside (blur)
  pw.addEventListener('blur', () => {
    // Optional: hide only if password is empty
    if (pw.value.trim() === "") {
      list.style.display = "none";
    }
  });
})();

</script>

</body>
</html>
